# è®¢å•å›è°ƒæœºåˆ¶è¯¦è§£

## 1. é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
> "æˆ‘æƒ³å’Œä½ å†è¯·æ•™ä¸€ä¸‹å›è°ƒå‡½æ•°è¿™å—ã€‚æˆ‘ç†è§£ç›®å‰æ˜¯tickermanager çŸ¥é“ pairs, åœ¨å®ƒon_order_event è¿™ä¸ªæ–¹æ³•å†…éƒ¨å›è°ƒ pairs ä¸­çš„ on_position_filled è¿™ä¸ªå‡½æ•°ã€‚ä½†æ˜¯æˆ‘å¥½åƒæ²¡æœ‰çœ‹åˆ°åœ¨main.pyä¸­è°ƒç”¨ on_order_eventå•Šï¼ï¼Ÿ"

### æ ¸å¿ƒå›°æƒ‘
- âœ… ç†è§£äº†å›è°ƒå…³ç³»: `TicketsManager.on_order_event()` â†’ `Pairs.on_position_filled()`
- â“ ç–‘æƒ‘ç‚¹: åœ¨main.pyä¸­æ²¡æœ‰çœ‹åˆ°è°ƒç”¨`on_order_event()`çš„ä»£ç 
- ğŸ” å…³é”®é—®é¢˜: è°åœ¨ä»€ä¹ˆæ—¶å€™è°ƒç”¨äº†`on_order_event()`?

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture)

æœ¬é¡¹ç›®é‡‡ç”¨çš„æ˜¯**äº‹ä»¶é©±åŠ¨æ¶æ„**,è€Œä¸æ˜¯å‘½ä»¤å¼è°ƒç”¨:

**å‘½ä»¤å¼è°ƒç”¨**(ä½ æœŸæœ›çœ‹åˆ°çš„):
```python
# main.py
def OnData(self, data):
    tickets = pair.open_position(...)
    if tickets:
        # âŒ æ‰‹åŠ¨è°ƒç”¨(è¿™æ ·æ˜¯é”™çš„!)
        self.tickets_manager.on_order_event(???)
```

**äº‹ä»¶é©±åŠ¨**(å®é™…çš„å®ç°):
```python
# main.py
def OnData(self, data):
    tickets = pair.open_position(...)
    if tickets:
        # åªéœ€æ³¨å†Œè®¢å•
        self.tickets_manager.register_tickets(pair_id, tickets)
        # âœ… ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨on_order_event
        # QuantConnectæ¡†æ¶ä¼šåœ¨è®¢å•çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨OnOrderEvent

def OnOrderEvent(self, event):  # â† æ¡†æ¶è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•!
    self.tickets_manager.on_order_event(event)
```

### 2.2 è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

æ•´ä¸ªå›è°ƒæœºåˆ¶å®ç°äº†ç»å…¸çš„**è§‚å¯Ÿè€…æ¨¡å¼**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QuantConnectæ¡†æ¶        â”‚ â† äº‹ä»¶æº(Subject)
â”‚ (è®¢å•çŠ¶æ€å˜åŒ–)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ è‡ªåŠ¨è§¦å‘
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ main.py.OnOrderEvent   â”‚ â† äº‹ä»¶æ¥æ”¶è€…(Observer)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ è½¬å‘
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TicketsManager         â”‚ â† äº‹ä»¶åˆ†å‘å™¨(Dispatcher)
â”‚ .on_order_event()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ å›è°ƒ
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pairs                  â”‚ â† æœ€ç»ˆå¤„ç†å™¨(Handler)
â”‚ .on_position_filled()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 QuantConnectè™šæ–¹æ³•æœºåˆ¶

`OnOrderEvent`æ˜¯`QCAlgorithm`çš„**è™šæ–¹æ³•**(virtual method):
- æ¡†æ¶åœ¨è®¢å•çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨
- æˆ‘ä»¬é€šè¿‡**ç»§æ‰¿å¹¶é‡å†™**æ¥"åŠ«æŒ"è¿™ä¸ªäº‹ä»¶æµ
- å®Œå…¨ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨

---

## 3. å®Œæ•´çš„è°ƒç”¨é“¾è·¯

### ç¬¬1å±‚: QuantConnectæ¡†æ¶ â†’ main.py

**è§¦å‘æ—¶æœº**: å½“ä»»ä½•è®¢å•çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶(æäº¤/éƒ¨åˆ†æˆäº¤/å®Œå…¨æˆäº¤/å–æ¶ˆç­‰)

**ä»£ç ä½ç½®**: `main.py:252-261`

```python
def OnOrderEvent(self, event):
    """
    è®¢å•äº‹ä»¶å›è°ƒ

    å…³é”®ç‚¹:
    - OnOrderEventæ˜¯QCAlgorithmçš„è™šæ–¹æ³•
    - QuantConnectæ¡†æ¶ä¼šè‡ªåŠ¨è°ƒç”¨,ä¸éœ€è¦æ‰‹åŠ¨è§¦å‘
    - æˆ‘ä»¬é€šè¿‡ç»§æ‰¿å¹¶é‡å†™æ¥åŠ«æŒäº‹ä»¶æµ
    """
    # å§”æ‰˜ç»™TicketsManagerå¤„ç†
    self.tickets_manager.on_order_event(event)

    # æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸é…å¯¹éœ€è¦å¤„ç†
    anomaly_pairs = self.tickets_manager.get_anomaly_pairs()
    if anomaly_pairs:
        for pair_id in anomaly_pairs:
            self.Debug(f"[è®¢å•å¼‚å¸¸] {pair_id} æ£€æµ‹åˆ°å•è…¿å¤±è´¥,å·²æ ‡è®°å¼‚å¸¸")
```

**èŒè´£**:
- âœ… æ¥æ”¶æ¡†æ¶çš„è®¢å•äº‹ä»¶
- âœ… è½¬å‘ç»™TicketsManagerå¤„ç†
- âœ… æ£€æŸ¥è®¢å•å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—
- âŒ ä¸è´Ÿè´£è®¢å•çŠ¶æ€è¿½è¸ª(å§”æ‰˜ç»™TicketsManager)

---

### ç¬¬2å±‚: main.py â†’ TicketsManager

**ä»£ç ä½ç½®**: `src/TicketsManager.py:189-246`

```python
def on_order_event(self, event: OrderEvent):
    """
    å¤„ç†QuantConnectçš„è®¢å•äº‹ä»¶å›è°ƒ

    çŠ¶æ€è½¬æ¢:
        æ³¨å†Œè®¢å• â†’ PENDING â†’ OnOrderEventè§¦å‘ â†’ COMPLETED/ANOMALY
                                            â†“
                                    å›è°ƒPairs.on_position_filled()

    Args:
        event: QuantConnectçš„OrderEventå¯¹è±¡
    """
    order_id = event.OrderId

    # æ­¥éª¤1: æŸ¥æ‰¾æ‰€å±é…å¯¹(é€šè¿‡OrderIdâ†’pair_idæ˜ å°„)
    pair_id = self.order_to_pair.get(order_id)
    if pair_id is None:
        return  # ä¸æ˜¯é…å¯¹è®¢å•,å¿½ç•¥

    # æ­¥éª¤2: è·å–å®æ—¶çŠ¶æ€(ä»OrderTicket.Statusæ¨å¯¼)
    current_status = self.get_pair_status(pair_id)

    # æ­¥éª¤3: è®°å½•çŠ¶æ€å˜åŒ–
    self.algorithm.Debug(
        f"[OOE] {pair_id} OrderId={order_id} "
        f"Status={event.Status} â†’ é…å¯¹çŠ¶æ€:{current_status}"
    )

    # æ­¥éª¤4: å…³é”®æ—¶åˆ» - æ‰€æœ‰è®¢å•éƒ½Filledæ—¶è§¦å‘å›è°ƒ!
    if current_status == "COMPLETED":
        # è·å–åŠ¨ä½œç±»å‹å’ŒPairså¯¹è±¡
        action = self.pair_actions.get(pair_id)
        pairs_obj = self.pairs_manager.get_pair_by_id(pair_id)

        if pairs_obj and action:
            # è·å–æœ€åä¸€æ¡è…¿æˆäº¤çš„æ—¶é—´(ç¡®ä¿åŒè…¿éƒ½å·²æˆäº¤)
            tickets = self.pair_tickets[pair_id]
            fill_time = max(
                t.Time for t in tickets
                if t is not None and t.Status == OrderStatus.Filled
            )

            # â­ è¿™é‡Œè§¦å‘å›è°ƒ!
            pairs_obj.on_position_filled(action, fill_time, tickets)

            self.algorithm.Debug(f"[OOE] {pair_id} è®¢å•å…¨éƒ¨æˆäº¤,é…å¯¹è§£é”")

    elif current_status == "ANOMALY":
        self.algorithm.Debug(
            f"[OOE] {pair_id} è®¢å•å¼‚å¸¸({event.Status}),éœ€é£æ§ä»‹å…¥"
        )
```

**æ ¸å¿ƒé€»è¾‘**:
1. **OrderId â†’ pair_idæŸ¥æ‰¾**: é€šè¿‡`self.order_to_pair`å­—å…¸
2. **çŠ¶æ€å®æ—¶è®¡ç®—**: è°ƒç”¨`get_pair_status()`æ£€æŸ¥æ‰€æœ‰OrderTicketçš„çŠ¶æ€
3. **COMPLETEDæ—¶è§¦å‘å›è°ƒ**: å½“æ‰€æœ‰è®¢å•éƒ½Filledæ—¶
4. **è·å–Pairså¯¹è±¡**: é€šè¿‡`pairs_manager.get_pair_by_id()`
5. **è°ƒç”¨å›è°ƒæ–¹æ³•**: `pairs_obj.on_position_filled()`

**çŠ¶æ€æ¨å¯¼æ–¹æ³•** (`get_pair_status`):
```python
def get_pair_status(self, pair_id: str) -> str:
    """
    å®æ—¶è®¡ç®—é…å¯¹çš„è®¢å•çŠ¶æ€

    çŠ¶æ€æ˜ å°„è§„åˆ™:
    - æ— è®¢å•è®°å½• â†’ "NONE"
    - æ‰€æœ‰è®¢å•Filled â†’ "COMPLETED"
    - ä»»ä¸€è®¢å•Canceled/Invalid â†’ "ANOMALY"
    - å…¶ä»–(Submitted/PartiallyFilled) â†’ "PENDING"
    """
    tickets = self.pair_tickets.get(pair_id)
    if not tickets:
        return "NONE"

    valid_tickets = [t for t in tickets if t is not None]
    if not valid_tickets:
        return "NONE"

    all_filled = all(t.Status == OrderStatus.Filled for t in valid_tickets)
    has_canceled = any(
        t.Status in [OrderStatus.Canceled, OrderStatus.Invalid]
        for t in valid_tickets
    )

    if all_filled:
        return "COMPLETED"
    elif has_canceled:
        return "ANOMALY"
    else:
        return "PENDING"
```

---

### ç¬¬3å±‚: TicketsManager â†’ Pairs

**ä»£ç ä½ç½®**: `src/Pairs.py:108-135`

```python
def on_position_filled(self, action: str, fill_time, tickets):
    """
    è®¢å•æˆäº¤å›è°ƒ(ç”±TicketsManagerè°ƒç”¨)

    è§¦å‘æ—¶æœº: TicketsManageræ£€æµ‹åˆ°é…å¯¹çš„æ‰€æœ‰è®¢å•éƒ½å·²Filledæ—¶

    Args:
        action: OrderAction.OPEN æˆ– OrderAction.CLOSE
        fill_time: æœ€åä¸€æ¡è…¿æˆäº¤çš„æ—¶é—´(ç¡®ä¿ä¸¤è…¿éƒ½å·²æˆäº¤)
        tickets: List[OrderTicket] æˆäº¤çš„è®¢å•ç¥¨æ®åˆ—è¡¨,ç”¨äºæå–å®é™…æˆäº¤æ•°é‡
    """
    if action == OrderAction.OPEN:
        # è®°å½•å¼€ä»“æ—¶é—´
        self.position_opened_time = fill_time

        # ä»OrderTicketæå–å®é™…æˆäº¤æ•°é‡å¹¶æ›´æ–°tracked_qty
        for ticket in tickets:
            if ticket is not None and ticket.Status == OrderStatus.Filled:
                if ticket.Symbol == self.symbol1:
                    self.tracked_qty1 = ticket.QuantityFilled
                elif ticket.Symbol == self.symbol2:
                    self.tracked_qty2 = ticket.QuantityFilled

    elif action == OrderAction.CLOSE:
        # è®°å½•å¹³ä»“æ—¶é—´
        self.position_closed_time = fill_time

        # å¹³ä»“åæ¸…é›¶tracked_qty
        self.tracked_qty1 = 0
        self.tracked_qty2 = 0
```

**èŒè´£**:
1. **è®°å½•å¼€/å¹³ä»“æ—¶é—´**: `position_opened_time` / `position_closed_time`
2. **æ›´æ–°æŒä»“è¿½è¸ª**: `tracked_qty1` / `tracked_qty2`
3. **ä»OrderTicketæå–å®é™…æ•°é‡**: è€Œä¸æ˜¯ä¾èµ–Portfolio(é¿å…æ··æ·†)

---

## 4. å®Œæ•´æµç¨‹å›¾

### 4.1 ä¸ƒæ­¥è°ƒç”¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·åœ¨OnDataä¸­æ‰§è¡Œäº¤æ˜“                                     â”‚
â”‚    tickets = pair.open_position(signal, margin, data)       â”‚
â”‚    self.tickets_manager.register_tickets(pair_id, tickets)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. TicketsManagerå»ºç«‹æ˜ å°„                                    â”‚
â”‚    self.order_to_pair[ticket.OrderId] = pair_id            â”‚
â”‚    self.pair_tickets[pair_id] = tickets                     â”‚
â”‚    çŠ¶æ€: NONE â†’ PENDING                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. QuantConnectæ¡†æ¶è‡ªåŠ¨è§¦å‘(è®¢å•çŠ¶æ€å˜åŒ–æ—¶)                   â”‚
â”‚    framework.OnOrderEvent(event) [è‡ªåŠ¨è°ƒç”¨,æ— éœ€æ‰‹åŠ¨è§¦å‘]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. main.pyè½¬å‘äº‹ä»¶                                           â”‚
â”‚    def OnOrderEvent(self, event):                           â”‚
â”‚        self.tickets_manager.on_order_event(event)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. TicketsManagerå¤„ç†äº‹ä»¶                                    â”‚
â”‚    - é€šè¿‡OrderIdæ‰¾åˆ°pair_id                                  â”‚
â”‚    - æ£€æŸ¥æ‰€æœ‰OrderTicketçš„Status                             â”‚
â”‚    - å¦‚æœå…¨éƒ¨Filled â†’ çŠ¶æ€å˜ä¸ºCOMPLETED                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼ (å½“current_status == "COMPLETED")
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. TicketsManagerè§¦å‘å›è°ƒ                                    â”‚
â”‚    pairs_obj = self.pairs_manager.get_pair_by_id(pair_id)  â”‚
â”‚    pairs_obj.on_position_filled(action, fill_time, tickets)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Pairsè®°å½•æ—¶é—´å’ŒæŒä»“                                        â”‚
â”‚    self.position_opened_time = fill_time                    â”‚
â”‚    self.tracked_qty1 = ticket.QuantityFilled                â”‚
â”‚    self.tracked_qty2 = ticket.QuantityFilled                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®ç»“æ„æ˜ å°„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OrderId â†’ pair_id æ˜ å°„ (TicketsManagerå†…éƒ¨)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ self.order_to_pair = {                                   â”‚
â”‚     123: "(AAPL, MSFT)",   # OrderId 123å±äºè¿™ä¸ªé…å¯¹     â”‚
â”‚     124: "(AAPL, MSFT)",   # OrderId 124ä¹Ÿå±äº(å¦ä¸€æ¡è…¿) â”‚
â”‚     125: "(GOOGL, AMZN)",  # OrderId 125å±äºå¦ä¸€ä¸ªé…å¯¹   â”‚
â”‚ }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pair_id â†’ OrderTickets æ˜ å°„ (TicketsManagerå†…éƒ¨)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ self.pair_tickets = {                                    â”‚
â”‚     "(AAPL, MSFT)": [<OrderTicket#123>, <OrderTicket#124>], â”‚
â”‚     "(GOOGL, AMZN)": [<OrderTicket#125>, <OrderTicket#126>],â”‚
â”‚ }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pair_id â†’ Pairså¯¹è±¡ æŸ¥æ‰¾ (PairsManagerå†…éƒ¨)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pairs_obj = self.pairs_manager.get_pair_by_id(pair_id)  â”‚
â”‚                                                           â”‚
â”‚ PairsManager.all_pairs = {                               â”‚
â”‚     "(AAPL, MSFT)": <Pairs object at 0x...>,            â”‚
â”‚     "(GOOGL, AMZN)": <Pairs object at 0x...>,           â”‚
â”‚ }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. å®Œæ•´æ—¶åºç¤ºä¾‹

å‡è®¾æˆ‘ä»¬å¼€ä»“`(AAPL, MSFT)`é…å¯¹,å®Œæ•´çš„æ—¶é—´çº¿å¦‚ä¸‹:

### T0: OnDataè°ƒç”¨ - æ³¨å†Œè®¢å•

```python
# main.py OnDataæ–¹æ³•ä¸­
signal = TradingSignal.LONG_SPREAD
margin = 10000

# æ‰§è¡Œå¼€ä»“
tickets = pair.open_position(signal, margin, data)
# è¿”å›: [ticket_123 (AAPL long), ticket_124 (MSFT short)]

# æ³¨å†Œåˆ°TicketsManager
self.tickets_manager.register_tickets("(AAPL, MSFT)", tickets, OrderAction.OPEN)

# å»ºç«‹æ˜ å°„
# order_to_pair[123] = "(AAPL, MSFT)"
# order_to_pair[124] = "(AAPL, MSFT)"
# pair_tickets["(AAPL, MSFT)"] = [ticket_123, ticket_124]
# pair_actions["(AAPL, MSFT)"] = "OPEN"

# çŠ¶æ€: NONE â†’ PENDING (å› ä¸ºè®¢å•åˆšæäº¤,è¿˜æœªæˆäº¤)
```

### T1: OrderId=123æˆäº¤ (AAPL long)

```python
# QuantConnectæ¡†æ¶è‡ªåŠ¨è°ƒç”¨
OnOrderEvent(event_123)  # event_123.Status = OrderStatus.Filled

# main.pyè½¬å‘
self.tickets_manager.on_order_event(event_123)

# TicketsManagerå¤„ç†
pair_id = self.order_to_pair[123]  # "(AAPL, MSFT)"
current_status = self.get_pair_status(pair_id)

# æ£€æŸ¥çŠ¶æ€:
# ticket_123: OrderStatus.Filled âœ…
# ticket_124: OrderStatus.Submitted â³
# â†’ current_status = "PENDING" (è¿˜æœ‰è®¢å•æœªå®Œæˆ)

# è¾“å‡ºæ—¥å¿—
self.algorithm.Debug(
    f"[OOE] (AAPL, MSFT) OrderId=123 Status=Filled â†’ é…å¯¹çŠ¶æ€:PENDING"
)

# ä¸è§¦å‘å›è°ƒ,ç»§ç»­ç­‰å¾…ç¬¬äºŒæ¡è…¿æˆäº¤
```

### T2: OrderId=124æˆäº¤ (MSFT short) - è§¦å‘å›è°ƒ!

```python
# QuantConnectæ¡†æ¶è‡ªåŠ¨è°ƒç”¨
OnOrderEvent(event_124)  # event_124.Status = OrderStatus.Filled

# main.pyè½¬å‘
self.tickets_manager.on_order_event(event_124)

# TicketsManagerå¤„ç†
pair_id = self.order_to_pair[124]  # "(AAPL, MSFT)"
current_status = self.get_pair_status(pair_id)

# æ£€æŸ¥çŠ¶æ€:
# ticket_123: OrderStatus.Filled âœ…
# ticket_124: OrderStatus.Filled âœ…
# â†’ current_status = "COMPLETED" (æ‰€æœ‰è®¢å•å·²å®Œæˆ!)

# è¾“å‡ºæ—¥å¿—
self.algorithm.Debug(
    f"[OOE] (AAPL, MSFT) OrderId=124 Status=Filled â†’ é…å¯¹çŠ¶æ€:COMPLETED"
)

# â­ è§¦å‘å›è°ƒ!
action = self.pair_actions["(AAPL, MSFT)"]  # "OPEN"
pairs_obj = self.pairs_manager.get_pair_by_id("(AAPL, MSFT)")
tickets = self.pair_tickets["(AAPL, MSFT)"]
fill_time = max(ticket_123.Time, ticket_124.Time)  # T2æ—¶åˆ»

# å›è°ƒPairså¯¹è±¡
pairs_obj.on_position_filled("OPEN", fill_time, tickets)

# Pairså†…éƒ¨æ‰§è¡Œ:
# self.position_opened_time = T2
# self.tracked_qty1 = ticket_123.QuantityFilled  # ä¾‹: 100
# self.tracked_qty2 = ticket_124.QuantityFilled  # ä¾‹: -150

# è¾“å‡ºæ—¥å¿—
self.algorithm.Debug(f"[OOE] (AAPL, MSFT) è®¢å•å…¨éƒ¨æˆäº¤,é…å¯¹è§£é”")
```

### å…³é”®æ—¶é—´ç‚¹å¯¹æ¯”

| æ—¶åˆ» | äº‹ä»¶ | ticket_123çŠ¶æ€ | ticket_124çŠ¶æ€ | é…å¯¹çŠ¶æ€ | æ˜¯å¦å›è°ƒ |
|------|------|---------------|---------------|---------|---------|
| T0   | æ³¨å†Œè®¢å• | Submitted | Submitted | PENDING | âŒ |
| T1   | AAPLæˆäº¤ | **Filled** | Submitted | PENDING | âŒ |
| T2   | MSFTæˆäº¤ | Filled | **Filled** | **COMPLETED** | âœ… å›è°ƒ! |

---

## 6. å…³é”®æ•°æ®ç»“æ„

### 6.1 TicketsManageræ ¸å¿ƒå­—å…¸

```python
class TicketsManager:
    def __init__(self, algorithm, pairs_manager):
        # === æ ¸å¿ƒæ•°æ®ç»“æ„ ===

        # 1. OrderId â†’ pair_id æ˜ å°„ (O(1)æŸ¥æ‰¾,ä¾›OnOrderEventä½¿ç”¨)
        # ç”¨é€”: å½“æ”¶åˆ°è®¢å•äº‹ä»¶æ—¶,å¿«é€Ÿæ‰¾åˆ°æ‰€å±é…å¯¹
        self.order_to_pair: Dict[int, str] = {}
        # ä¾‹: {123: "(AAPL, MSFT)", 124: "(AAPL, MSFT)"}

        # 2. pair_id â†’ [OrderTicket] æ˜ å°„ (å­˜å‚¨å½“å‰è®¢å•å¼•ç”¨)
        # ç”¨é€”: æ£€æŸ¥é…å¯¹çš„æ‰€æœ‰è®¢å•çŠ¶æ€,è®¡ç®—é…å¯¹çŠ¶æ€
        self.pair_tickets: Dict[str, List[OrderTicket]] = {}
        # ä¾‹: {"(AAPL, MSFT)": [<OrderTicket#123>, <OrderTicket#124>]}

        # 3. pair_id â†’ action æ˜ å°„ (è®°å½•è®¢å•åŠ¨ä½œç±»å‹,ç”¨äºå›è°ƒPairs)
        # ç”¨é€”: å›è°ƒæ—¶å‘ŠçŸ¥Pairsæ˜¯å¼€ä»“è¿˜æ˜¯å¹³ä»“
        self.pair_actions: Dict[str, str] = {}
        # ä¾‹: {"(AAPL, MSFT)": "OPEN"}
```

### 6.2 ä¸‰çº§æ˜ å°„æŸ¥æ‰¾é“¾è·¯

```python
# æ­¥éª¤1: OrderId â†’ pair_id
order_id = 123
pair_id = self.order_to_pair[order_id]  # "(AAPL, MSFT)"

# æ­¥éª¤2: pair_id â†’ OrderTickets
tickets = self.pair_tickets[pair_id]  # [<OrderTicket#123>, <OrderTicket#124>]

# æ­¥éª¤3: pair_id â†’ Pairså¯¹è±¡
pairs_obj = self.pairs_manager.get_pair_by_id(pair_id)  # <Pairs object>

# æ­¥éª¤4: è·å–åŠ¨ä½œç±»å‹
action = self.pair_actions[pair_id]  # "OPEN"

# æ­¥éª¤5: è§¦å‘å›è°ƒ
pairs_obj.on_position_filled(action, fill_time, tickets)
```

### 6.3 çŠ¶æ€æ¨å¯¼ä¾èµ–

```python
# TicketsManagerä¸å­˜å‚¨çŠ¶æ€,è€Œæ˜¯å®æ—¶ä»OrderTicketæ¨å¯¼
def get_pair_status(self, pair_id: str) -> str:
    tickets = self.pair_tickets.get(pair_id)

    # ä¾èµ–OrderTicket.Status (å•ä¸€æ•°æ®æº)
    all_filled = all(t.Status == OrderStatus.Filled for t in tickets)
    has_canceled = any(t.Status in [OrderStatus.Canceled, OrderStatus.Invalid]
                       for t in tickets)

    # æ¨å¯¼ç»“æœ: NONE | PENDING | COMPLETED | ANOMALY
    if all_filled:
        return "COMPLETED"  # â† è¿™é‡Œè§¦å‘å›è°ƒ
    elif has_canceled:
        return "ANOMALY"
    else:
        return "PENDING"
```

---

## 7. è®¾è®¡ä¼˜åŠ¿

### 7.1 è§£è€¦ (Decoupling)

```
main.py (ä¸šåŠ¡é€»è¾‘)
   â†“ åªéœ€æ³¨å†Œè®¢å•
TicketsManager (è®¢å•è¿½è¸ª)
   â†“ è‡ªåŠ¨è§¦å‘å›è°ƒ
Pairs (æŒä»“è®°å½•)
```

- `main.py`ä¸éœ€è¦çŸ¥é“è®¢å•è¿½è¸ªçš„ç»†èŠ‚
- `Pairs`ä¸éœ€è¦çŸ¥é“è®¢å•çŠ¶æ€çš„æ¨å¯¼é€»è¾‘
- å„æ¨¡å—èŒè´£æ¸…æ™°,ç‹¬ç«‹ä¿®æ”¹

### 7.2 è‡ªåŠ¨åŒ– (Automation)

- âŒ ä¸éœ€è¦åœ¨OnDataä¸­æ‰‹åŠ¨è½®è¯¢è®¢å•çŠ¶æ€
- âŒ ä¸éœ€è¦å†™å¤æ‚çš„çŠ¶æ€æ£€æŸ¥é€»è¾‘
- âœ… æ¡†æ¶è‡ªåŠ¨è§¦å‘,è®¢å•çŠ¶æ€å˜åŒ–ç«‹å³å“åº”
- âœ… åŸºäºäº‹ä»¶é©±åŠ¨,é›¶å»¶è¿Ÿå¤„ç†

### 7.3 èŒè´£åˆ†ç¦» (Separation of Concerns)

| æ¨¡å— | èŒè´£ | ä¸è´Ÿè´£ |
|------|------|--------|
| `main.py` | ä¸šåŠ¡æµç¨‹ç¼–æ’ã€é£é™©æ£€æŸ¥ | è®¢å•çŠ¶æ€è¿½è¸ª |
| `TicketsManager` | è®¢å•çŠ¶æ€è¿½è¸ªã€å¼‚å¸¸æ£€æµ‹ã€é”å®šæ§åˆ¶ | ä¸šåŠ¡é€»è¾‘ã€æŒä»“åˆ†æ |
| `Pairs` | æŒä»“è®°å½•ã€æ—¶é—´è¿½è¸ª | è®¢å•çŠ¶æ€æ¨å¯¼ |

### 7.4 å®æ—¶æ€§ (Real-time)

```
ä¼ ç»Ÿè½®è¯¢æ–¹å¼:
OnData â†’ æ£€æŸ¥è®¢å•1 â†’ æ£€æŸ¥è®¢å•2 â†’ ... â†’ æ£€æŸ¥è®¢å•N
         â†‘_____________________________________|
         (æ¯æ¬¡OnDataéƒ½è¦éå†æ‰€æœ‰è®¢å•,æ•ˆç‡ä½)

äº‹ä»¶é©±åŠ¨æ–¹å¼:
è®¢å•çŠ¶æ€å˜åŒ– â†’ OnOrderEventç«‹å³è§¦å‘ â†’ ç²¾å‡†å¤„ç†
(åªå¤„ç†çŠ¶æ€å˜åŒ–çš„è®¢å•,æ•ˆç‡é«˜)
```

### 7.5 å¯é æ€§ (Reliability)

- **å•ä¸€æ•°æ®æº**: çŠ¶æ€å®Œå…¨ç”±`OrderTicket.Status`æ¨å¯¼,ä¸ä¾èµ–å¤–éƒ¨çŠ¶æ€
- **å®æ—¶è®¡ç®—**: ä¸å­˜å‚¨çŠ¶æ€å¿«ç…§,é¿å…çŠ¶æ€è¿‡æœŸ
- **ç²¾ç¡®è¿½è¸ª**: é€šè¿‡`OrderId`ç²¾å‡†å®šä½,é¿å…é…å¯¹æ··æ·†
- **å¼‚å¸¸æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«`Canceled/Invalid`è®¢å•,è§¦å‘é£æ§

---

## 8. å¸¸è§è¯¯åŒº

### âŒ è¯¯åŒº1: è®¤ä¸ºéœ€è¦æ‰‹åŠ¨è°ƒç”¨on_order_event

```python
# âŒ é”™è¯¯ç†è§£
def OnData(self, data):
    tickets = pair.open_position(...)
    if tickets:
        # é”™è¯¯: è¯•å›¾æ‰‹åŠ¨è°ƒç”¨
        self.tickets_manager.on_order_event(???)
```

**æ­£ç¡®ç†è§£**: `on_order_event`ç”±QuantConnectæ¡†æ¶é€šè¿‡`OnOrderEvent`è‡ªåŠ¨è§¦å‘

### âŒ è¯¯åŒº2: è®¤ä¸ºOnOrderEventæ˜¯æ™®é€šæ–¹æ³•

```python
# âŒ é”™è¯¯ç†è§£
# OnOrderEventåªæ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•,éœ€è¦æ‰‹åŠ¨è°ƒç”¨
```

**æ­£ç¡®ç†è§£**: `OnOrderEvent`æ˜¯`QCAlgorithm`çš„è™šæ–¹æ³•(å›è°ƒæ¥å£),æ¡†æ¶è´Ÿè´£è°ƒç”¨

### âŒ è¯¯åŒº3: è®¤ä¸ºå›è°ƒæ˜¯åŒæ­¥ç­‰å¾…çš„

```python
# âŒ é”™è¯¯ç†è§£
def OnData(self, data):
    tickets = pair.open_position(...)
    # ç«‹å³ç­‰å¾…å›è°ƒå®Œæˆ?
    wait_for_callback()  # ä¸å­˜åœ¨è¿™æ ·çš„æœºåˆ¶
```

**æ­£ç¡®ç†è§£**: å›è°ƒæ˜¯å¼‚æ­¥çš„,åœ¨æœªæ¥æŸä¸ªæ—¶åˆ»(è®¢å•æˆäº¤æ—¶)æ‰ä¼šè§¦å‘

---

## 9. è°ƒè¯•æŠ€å·§

### 9.1 è¿½è¸ªè®¢å•ç”Ÿå‘½å‘¨æœŸ

åœ¨`TicketsManager.on_order_event`ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—:

```python
def on_order_event(self, event: OrderEvent):
    pair_id = self.order_to_pair.get(event.OrderId)
    if pair_id:
        current_status = self.get_pair_status(pair_id)

        # è¯¦ç»†æ—¥å¿—
        self.algorithm.Debug(
            f"[è®¢å•è¿½è¸ª] {pair_id} OrderId={event.OrderId} "
            f"{event.Symbol} {event.Status} â†’ é…å¯¹çŠ¶æ€:{current_status}"
        )
```

### 9.2 æ£€æŸ¥æ˜ å°„å…³ç³»

åœ¨æ³¨å†Œè®¢å•åéªŒè¯æ˜ å°„:

```python
def register_tickets(self, pair_id, tickets, action):
    self.pair_tickets[pair_id] = tickets
    self.pair_actions[pair_id] = action

    for ticket in tickets:
        if ticket:
            self.order_to_pair[ticket.OrderId] = pair_id

            # éªŒè¯æ˜ å°„
            self.algorithm.Debug(
                f"[æ˜ å°„éªŒè¯] OrderId={ticket.OrderId} â†’ pair_id={pair_id}"
            )
```

### 9.3 ç›‘æ§å›è°ƒè§¦å‘

åœ¨`Pairs.on_position_filled`ä¸­è®°å½•:

```python
def on_position_filled(self, action, fill_time, tickets):
    self.algorithm.Debug(
        f"[å›è°ƒè§¦å‘] {self.pair_id} {action} äº{fill_time} "
        f"qty1={self.tracked_qty1} qty2={self.tracked_qty2}"
    )
```

---

## 10. æ€»ç»“

### æ ¸å¿ƒç­”æ¡ˆ

**é—®é¢˜**: "åœ¨main.pyä¸­æ²¡æœ‰çœ‹åˆ°è°ƒç”¨on_order_event,ä¸ºä»€ä¹ˆå®ƒä¼šè¢«æ‰§è¡Œ?"

**ç­”æ¡ˆ**:
1. `on_order_event`ä¸æ˜¯æ‰‹åŠ¨è°ƒç”¨çš„,è€Œæ˜¯é€šè¿‡**äº‹ä»¶é©±åŠ¨æ¶æ„**è‡ªåŠ¨è§¦å‘
2. QuantConnectæ¡†æ¶åœ¨è®¢å•çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨`main.py.OnOrderEvent`
3. `main.py.OnOrderEvent`è½¬å‘äº‹ä»¶ç»™`TicketsManager.on_order_event`
4. `TicketsManager`æ£€æµ‹åˆ°è®¢å•å®Œæˆæ—¶,å›è°ƒ`Pairs.on_position_filled`

### å…³é”®è¦ç‚¹

| å±‚çº§ | è§¦å‘æ–¹å¼ | è°ƒç”¨è€… | è¢«è°ƒç”¨è€… |
|------|---------|--------|---------|
| 1 | æ¡†æ¶è‡ªåŠ¨ | QuantConnect | `main.py.OnOrderEvent` |
| 2 | æ‰‹åŠ¨è½¬å‘ | `main.py` | `TicketsManager.on_order_event` |
| 3 | æ¡ä»¶å›è°ƒ | `TicketsManager` | `Pairs.on_position_filled` |

### è®¾è®¡æ¨¡å¼

- **è§‚å¯Ÿè€…æ¨¡å¼**: æ¡†æ¶â†’Algorithmâ†’Managerâ†’Pairsçš„äº‹ä»¶ä¼ é€’
- **å•ä¸€èŒè´£**: æ¯ä¸ªæ¨¡å—åªåšä¸€ä»¶äº‹,ä¸è¶Šç•Œ
- **ä¾èµ–æ³¨å…¥**: TicketsManageræŒæœ‰PairsManagerå¼•ç”¨,ç”¨äºå›è°ƒ
- **çŠ¶æ€æ¨å¯¼**: ä¸å­˜å‚¨çŠ¶æ€,å®æ—¶ä»OrderTicketæ¨å¯¼

---

## é™„å½•: ç›¸å…³ä»£ç æ–‡ä»¶

- `main.py:252-261` - OnOrderEventæ–¹æ³•
- `src/TicketsManager.py:189-246` - on_order_eventæ–¹æ³•
- `src/TicketsManager.py:72-115` - get_pair_statusæ–¹æ³•
- `src/TicketsManager.py:120-159` - register_ticketsæ–¹æ³•
- `src/Pairs.py:108-135` - on_position_filledå›è°ƒæ–¹æ³•
- `src/PairsManager.py` - get_pair_by_idæŸ¥æ‰¾æ–¹æ³•

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-01-31
**ç‰ˆæœ¬**: v1.0
**é€‚ç”¨ç­–ç•¥ç‰ˆæœ¬**: v6.4.7+
