# 架构设计决策文档

本文档记录了贝叶斯协整策略的重要架构设计决策，特别是关于风控机制和模块职责的关键讨论。

## T+0 vs T+1 风控机制

### 背景
在量化交易系统中，风险控制可以分为两类：
- **T+0 风控**：基于当前市场数据和持仓状态的实时判断
- **T+1 风控**：需要历史交易信息才能判断的规则

### T+0 风控（实时可判断）
这类风控可以在 `Alpha → PC → Risk` 的正常数据流中处理：
- Portfolio 最大回撤
- 单个资产最大回撤
- 配对最大回撤
- 可用资金限制
- 做空能力检查

数据来源：`algorithm.Portfolio` 提供的实时持仓和市值信息

### T+1 风控（需要历史信息）
这类风控必须在订单执行后，通过 `OnOrderEvent` 获取实际成交信息：
- 持仓时间限制（需要知道实际建仓时间）
- 冷却期管理（需要知道上次平仓时间）
- 异常订单检测（需要订单执行反馈）

数据来源：`OnOrderEvent → OrderTracker` 记录的历史信息

## 模块职责边界

### 1. AlphaModel（信号生成）
**核心职责**：基于统计分析生成交易信号

**应该做的**：
- 数据质量检查
- 协整性检验
- 贝叶斯参数估计
- Z-score 计算和信号生成

**不应该做的**：
- ❌ 查询历史交易记录
- ❌ 检查冷却期状态
- ❌ 考虑持仓时间

**设计理念**：保持统计模型的纯粹性，不关心执行细节

### 2. PortfolioConstruction（信号转换）
**核心职责**：将交易信号转换为具体持仓权重

**应该做的**：
- 解析 Insight 参数
- 计算 Beta 中性权重
- 动态资金分配（5%-15%基于质量分数）
- 检查做空能力

**不应该做的**：
- ❌ 查询历史交易记录
- ❌ 检查冷却期
- ❌ 做风险判断

**设计理念**：纯粹的信号转换器，通过资金分配自然限制配对数量

### 3. RiskManagement（风险控制）
**核心职责**：双重风控机制

**主动风控**（每日执行，即使没有新信号）：
- 检查所有持仓的回撤
- 检查持仓时间是否超限
- 检查异常持仓状态
- 生成必要的平仓指令

**被动风控**（有新信号时执行）：
- 过滤处于冷却期的配对
- 检查是否重复建仓
- 验证风险限制

**设计理念**：作为最后的守门人，拥有完整的决策权

### 4. OrderTracker（订单跟踪）
**核心职责**：作为 OnOrderEvent 的唯一监听者

**应该做的**：
- 记录所有订单状态变化
- 维护建仓/平仓时间
- 计算持仓天数
- 管理冷却期状态

**不应该做的**：
- ❌ 管理配对关系（应该由 PairRegistry）
- ❌ 做风险决策
- ❌ 生成交易信号

**设计理念**：专注于订单生命周期管理

### 5. PairRegistry（配对注册）
**核心职责**：维护配对的选择状态

**应该做的**：
- 记录 AlphaModel 选出的配对
- 提供配对查询接口
- 维护配对的基本信息

**潜在改进**：
- 可以扩展为配对生命周期管理器
- 但需要避免与 OrderTracker 的职责重叠

## 关键设计原则

### 1. 查询即决策
如果一个模块查询了某个信息，它就应该基于这个信息做出相应的决策。无意义的查询只会增加耦合。

### 2. 信息流清晰胜过过早优化
宁可有一些"无效"的信号流到下游被过滤，也不要为了优化而破坏清晰的模块边界。

### 3. 单一数据源
- T+0 信息：从 Portfolio 获取
- T+1 信息：从 OrderTracker 获取
- 避免同一信息有多个来源

### 4. 职责单一但可以有双重任务
如 RiskManagement 有主动和被动两种风控任务，但都是"风险控制"这一单一职责的体现。

## 未来优化方向

### 1. 性能优化
如果确实需要减少无效信号：
- 可以在 Risk 层面做批量优化
- 而不是让上游模块过早过滤

### 2. 配对状态统一管理
长期可以考虑：
- 将 OrderTracker 的配对相关功能迁移到 PairRegistry
- 使 PairRegistry 成为配对状态的统一管理器
- 但要确保数据一致性

### 3. 事件驱动架构
更长期可以考虑事件总线模式，减少模块间的直接依赖。

## 总结

当前的架构设计虽然可能有一些效率上的"浪费"，但它提供了：
- 清晰的职责边界
- 简单的依赖关系
- 良好的可维护性
- 易于理解和调试

这些优点远比过早的优化更重要。随着系统的演进，可以在保持架构清晰的前提下逐步优化。