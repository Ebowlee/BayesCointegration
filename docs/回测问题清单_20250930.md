# 回测问题清单 - v6.4.0

**回测ID**: `7f9b49959f3276f3901524dfee66acb4`
**回测期**: 2024年6月20日 - 2024年9月20日 (3个月)
**总收益**: -1.41% (-$1,414.93)
**创建日期**: 2025年9月30日

---

## 问题优先级

### 🔴 优先级1 - 紧急Bug (功能缺陷)

#### ~~问题1: Cooldown机制在强制清算后失效~~ [✅ 已修复]

**严重程度**: 🔴 Critical
**影响**: 导致AMZN被交易14次,严重违反cooldown规则

**问题描述**:
- 正常平仓后cooldown生效 (如7/23平仓后44天才开新仓)
- 强制清算后cooldown失效 (9月份4次清算后1-2天就开新仓)

**根本原因**:
```python
# 正常平仓 - 有Tag,cooldown生效 ✅
def close_position(self):
    tag = self.create_order_tag(OrderAction.CLOSE)  # "pair_id_CLOSE_20240709"
    self.algorithm.Liquidate(self.symbol1, tag=tag)

# 强制清算 - 无Tag,cooldown失效 ❌
# main.py:256-258
self.Liquidate(pair.symbol1)  # 没有Tag!
self.Liquidate(pair.symbol2)
```

**检测逻辑**:
- `get_exit_time()` 通过查找Tag中包含"CLOSE"的订单来确定退出时间
- 强制清算的订单没有"CLOSE"标记,导致找不到退出时间
- `is_in_cooldown()` 返回False,允许立即开新仓

**影响数据**:
- AMZN-CMG配对: 5次cooldown违规 (7/19边界, 9/10, 9/13, 9/18)
- AMZN-GM配对: 1次cooldown违规 (9/5)
- 总计: 6次违规,导致14次AMZN交易

**修复方案**: 方案A - 统一使用`pair.close_position()`

**修复记录**:

**第一次修复** (2025年9月30日 - 部分生效):
- 修改文件: main.py (3处修改)
- 修改位置:
  - Line 256: 持仓超期清仓
  - Line 264: 持仓异常清仓
  - Line 271: 配对回撤清仓
- 修改内容: 将`self.Liquidate(pair.symbol1/2)`改为`pair.close_position()`
- **回测结果**: 回测ID `1554da274ce47117b380957827b40897`
  - AMZN交易次数: 14次 → 7次 (✅ 减少50%)
  - Cooldown合规率: 90% (9/10配对遵守)
  - **残留问题**: 9/4强制清算后9/5仍违规开仓

**第二次修复** (2025年9月30日 - 根本解决):
- 修改文件: src/Pairs.py
- 修改位置: Line 231-260 (close_position方法)
- **根本问题发现**: `Liquidate()`方法不支持tag参数!
  ```python
  # ❌ 第一次修复的问题
  self.algorithm.Liquidate(self.symbol1, tag=tag)  # tag参数被忽略!

  # ✅ 第二次修复的方案
  self.algorithm.MarketOrder(self.symbol1, -qty1, tag=tag)  # 正确支持tag
  ```
- **修改内容**:
  - 改用`MarketOrder(symbol, -quantity, tag=tag)`替代`Liquidate()`
  - 增加持仓检查,避免对0持仓下单
  - 确保所有平仓订单都带"CLOSE"标记
- **技术原理**:
  - QuantConnect的`Liquidate()`只接受symbol参数,不支持自定义tag
  - `MarketOrder()`支持tag参数,可正确标记订单
  - `get_exit_time()`依赖Tag中的"CLOSE"标记来追踪平仓时间

**预期效果**:
- AMZN交易次数进一步降低到4-6次
- Cooldown合规率: 100%
- 9/4→9/5的违规将被消除

**验证方法**: 运行相同回测,检查:
1. 日志中所有平仓订单都有"CLOSE"标记
2. 无任何1-2天cooldown违规
3. AMZN交易次数≤6次

**第三次回测验证** (2025年9月30日):
- **回测ID**: `35554859263c8c008df178addc7e29d6`
- **验证结果**: ✅ **完全成功!**

| 验证项 | 预期目标 | 实际结果 | 状态 |
|-------|---------|---------|------|
| AMZN交易次数 | ≤6次 | **5次** | ✅ 超预期 |
| Cooldown违规 | 0次 | **0次** | ✅ 完美 |
| Cooldown合规率 | 100% | **100%** | ✅ 完美 |
| 9/4→9/5违规 | 消除 | **已消除** | ✅ 修复 |

**关键验证 - 9/4强制清算案例**:
```
第二次回测(修复前):
  9/4: AMZN-GM强制清算
  9/5: AMZN-GM立即开仓 ❌ 违反cooldown

第三次回测(修复后):
  9/4: AMZN-GM强制清算
  9/5: AMZN-CMG开仓 ✅ 不同配对,合规
       AMZN-GM仍在cooldown ✅ 正确阻止
```

**三次回测改善轨迹**:
- 第一次(修复前): 14次交易, 多次违规
- 第二次(main.py修复): 7次交易, 1次违规 (改善50%)
- 第三次(Pairs.py修复): 5次交易, 0次违规 (改善64%, **完全修复**)

---

#### 问题2: 订单重复提交

**严重程度**: 🟡 High
**影响**: 造成不必要的交易成本和持仓混乱

**问题描述**:
- 8月19-20日出现订单重复提交
- 订单19-22和23-26几乎相同
- 可能是系统在短时间内重复调用开仓逻辑

**影响数据**:
- 至少2组重复订单 (共8个订单)
- 涉及MCHP-QCOM配对

**根本原因**: [待调查]
- 可能是OnData事件重入问题
- 可能是PairsManager状态管理问题

**修复方案**: [待讨论]

---

#### 问题3: 订单取消和执行失败

**严重程度**: 🟡 High
**影响**: 导致孤儿持仓(单边持仓)风险

**问题描述**:
- 订单#38 (GM) 状态为"cancelPending"
- 可能导致AMZN-GM配对只有一边成交

**影响数据**:
- 至少1个订单被取消
- AMZN-GM配对可能存在不完整持仓

**根本原因**: [待调查]
- 可能是市场流动性问题
- 可能是订单提交时机问题

**修复方案**: [待讨论]

---

### 🟡 优先级2 - 策略缺陷 (影响收益)

#### 问题4: 行业集中度超标

**严重程度**: 🟡 High
**影响**: 行业风险过度集中,违反风控规则

**问题数据**:
- 科技/半导体股票: ~60%暴露 (配置限制40%)
- 涉及股票: MCHP, QCOM, CSCO, ALGM
- 未见行业调整执行记录

**根本原因**: [待调查]
- `check_sector_concentration()` 被调用但未生效
- 可能返回需调整的配对,但未实际执行调整
- main.py:232-242的调整逻辑可能有问题

**修复方案**: [待讨论]

---

#### 问题5: 质量评分可能存在偏向

**严重程度**: 🟢 Medium
**影响**: 配对选择不够多样化

**问题描述**:
- AMZN (大市值) 被过度选中
- 可能是流动性评分过高导致
- 或者是质量评分偏向大市值股票

**影响数据**:
- AMZN出现在2-3个不同配对中
- 其他股票相对分散

**根本原因**: [待调查]
- 质量评分算法可能偏向:
  - 流动性指标 (20%权重,大市值股票占优)
  - 波动率比率 (大市值股票更稳定)

**修复方案**: [待讨论]

---

### 🟢 优先级3 - 策略优化 (提升性能)

#### 问题6: 信号阈值可能过于敏感

**严重程度**: 🟢 Medium
**影响**: 交易频率偏高,可能产生假信号

**问题数据**:
- 当前entry_threshold: ±1.0σ
- 平均持仓: 3-7天 (较短)
- 多个配对出现快速开平仓

**优化建议**:
- 提高entry_threshold到±1.5σ
- 观察持仓时长和胜率变化

---

#### 问题7: 止损阈值可能过于宽松

**严重程度**: 🟢 Medium
**影响**: 单笔亏损可能过大

**问题数据**:
- 当前stop_threshold: ±3.0σ
- 多个配对出现10%+浮亏才止损

**优化建议**:
- 降低stop_threshold到±2.5σ
- 更早止损,减少单笔损失

---

#### 问题8: 选股池可能不够大

**严重程度**: 🟢 Low
**影响**: 配对多样性不足

**问题数据**:
- 当前每行业15只股票
- 可能导致配对选择受限

**优化建议**:
- 提高到每行业20只股票
- 增加配对多样性

---

## 问题解决进度

| 问题 | 状态 | 负责模块 | 预计工作量 |
|------|------|----------|-----------|
| ~~问题1: Cooldown失效~~ | ✅ 已修复 | main.py | 1小时 |
| 问题2: 订单重复 | 🟡 待调查 | main.py, PairsManager.py | 4小时 |
| 问题3: 订单取消 | 🟡 待调查 | Pairs.py | 2小时 |
| 问题4: 行业集中度 | 🟡 待调查 | main.py | 2小时 |
| 问题5: 质量评分偏向 | 🟢 待评估 | PairSelector.py | 4小时 |
| 问题6: 信号阈值 | 🟢 待测试 | config.py | 1小时 |
| 问题7: 止损阈值 | 🟢 待测试 | config.py | 1小时 |
| 问题8: 选股池 | 🟢 待评估 | config.py | 1小时 |

---

## 修复验证标准

### 问题1验证标准:
- [ ] 所有配对平仓后cooldown生效
- [ ] AMZN类股票交易次数≤8次
- [ ] 无违反cooldown规则的交易

### 问题4验证标准:
- [ ] 任意时刻单行业暴露≤40%
- [ ] 出现超标时有调整执行记录
- [ ] 科技股暴露≤40%

---

## 回测改进目标

**短期目标** (修复优先级1问题后):
- 3个月收益率: 0% ~ +2%
- 最大回撤: ≤3%
- AMZN交易次数: ≤8次
- 无cooldown违规

**中期目标** (修复优先级1+2问题后):
- 3个月收益率: +3% ~ +5%
- Sharpe比率: >0.8
- 行业集中度合规率: 100%
- 订单执行成功率: >98%

**长期目标** (全部优化完成后):
- 6-12个月回测验证
- 年化收益率: >10%
- Sharpe比率: >1.2
- 最大回撤: <10%

---

## 备注

- 本文档随问题修复动态更新
- 已解决问题标记~~删除线~~
- 新发现问题按优先级插入对应章节